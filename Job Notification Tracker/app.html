<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Job Notification Tracker — built on the KodNest Premium Build System." />
  <title>Job Notification Tracker</title>

  <!-- KodNest Design System (tokens → base → components → layout → states) -->
  <link rel="stylesheet" href="design-system/index.css" />
  <!-- App-level navigation and route shell styles -->
  <link rel="stylesheet" href="app.css" />
  <!-- Phase 4: 60-job dataset (assigns window.JOBS) -->
  <script src="data/jobs.js"></script>
</head>
<body>

  <!-- ══════════════════════════════════════════════
       TOP NAVIGATION BAR
  ══════════════════════════════════════════════ -->
  <nav class="app-nav" role="navigation" aria-label="Main navigation">
    <div class="app-nav__inner">

      <!-- Brand -->
      <a href="#/" class="app-nav__brand" aria-label="Job Notification Tracker home">
        <span class="app-nav__brand-dot" aria-hidden="true"></span>
        <span class="app-nav__brand-name">Job Notification Tracker</span>
      </a>

      <!-- Desktop links -->
      <ul class="app-nav__links" role="list" id="desktop-nav">
        <li class="app-nav__link" data-route="/dashboard">
          <a href="#/dashboard">Dashboard</a>
        </li>
        <li class="app-nav__link" data-route="/saved">
          <a href="#/saved">Saved</a>
        </li>
        <li class="app-nav__link" data-route="/digest">
          <a href="#/digest">Digest</a>
        </li>
        <li class="app-nav__link" data-route="/settings">
          <a href="#/settings">Settings</a>
        </li>
        <li class="app-nav__link" data-route="/proof">
          <a href="#/proof">Proof</a>
        </li>
      </ul>

      <!-- Right slot (reserved for future: bell, avatar) -->
      <div class="app-nav__right" aria-hidden="true"></div>

      <!-- Hamburger (mobile) -->
      <button
        class="app-nav__hamburger"
        id="hamburger-btn"
        aria-label="Toggle navigation menu"
        aria-expanded="false"
        aria-controls="mobile-menu"
      >
        <span class="app-nav__hamburger-bar"></span>
        <span class="app-nav__hamburger-bar"></span>
        <span class="app-nav__hamburger-bar"></span>
      </button>

    </div>
  </nav>

  <!-- Mobile menu drawer (toggled by hamburger) -->
  <div class="app-nav__mobile-menu" id="mobile-menu" role="dialog" aria-label="Mobile navigation" aria-hidden="true">
    <ul class="app-nav__mobile-links" role="list">
      <li class="app-nav__mobile-link" data-route="/dashboard">
        <a href="#/dashboard">Dashboard</a>
      </li>
      <li class="app-nav__mobile-link" data-route="/saved">
        <a href="#/saved">Saved</a>
      </li>
      <li class="app-nav__mobile-link" data-route="/digest">
        <a href="#/digest">Digest</a>
      </li>
      <li class="app-nav__mobile-link" data-route="/settings">
        <a href="#/settings">Settings</a>
      </li>
      <li class="app-nav__mobile-link" data-route="/proof">
        <a href="#/proof">Proof</a>
      </li>
    </ul>
  </div>


  <!-- ══════════════════════════════════════════════
       APP BODY — all route views rendered here
  ══════════════════════════════════════════════ -->
  <div class="app-body">

    <!-- ── Route: / (Home — Landing Page) ─────── -->
    <div class="route-view" data-view="/" id="view-home" role="main" aria-label="Home">
      <div class="landing-hero">
        <span class="landing-hero__eyebrow label text-muted">Job Notification Tracker</span>
        <h1 class="landing-hero__heading">Stop Missing<br>The Right Jobs.</h1>
        <p class="landing-hero__subtext">Precision-matched job discovery delivered daily at 9AM.</p>
        <a href="#/settings" class="btn btn--primary landing-hero__cta">Start Tracking</a>
        <div class="landing-hero__proof">
          <span class="landing-hero__proof-dot" aria-hidden="true"></span>
          <span class="label text-muted">Built for students who are serious about landing the right role</span>
        </div>
      </div>
    </div>

    <!-- ── Route: /dashboard ───────────────────── -->
    <div class="route-view" data-view="/dashboard" id="view-dashboard" role="main" aria-label="Dashboard">

      <!-- Page header -->
      <div class="route-placeholder" style="padding-bottom: 0;">
        <span class="route-placeholder__eyebrow label text-muted">Overview</span>
        <h1 class="route-placeholder__heading">Dashboard</h1>
        <p class="route-placeholder__subtext">60 real Indian tech opportunities — match-scored against your preferences. Filter, save, and apply.</p>
        <div class="route-placeholder__divider" aria-hidden="true"></div>
      </div>

      <!-- No-preferences banner (hidden when prefs are set) -->
      <div id="pref-banner" class="pref-banner" role="status" aria-live="polite" style="display:none;">
        <span class="pref-banner__icon" aria-hidden="true">&#9432;</span>
        <span class="pref-banner__text">Set your preferences to activate intelligent matching. <a href="#/settings" class="pref-banner__link">Go to Settings &rarr;</a></span>
      </div>

      <!-- Filter bar -->
      <div class="filter-bar" id="filter-bar" role="search" aria-label="Filter jobs">
        <div class="filter-bar__inner">
          <input
            id="filter-keyword"
            type="search"
            class="input filter-bar__search"
            placeholder="Search title or company…"
            aria-label="Search by title or company"
          />
          <select id="filter-location" class="select filter-bar__select" aria-label="Filter by location">
            <option value="">All Locations</option>
            <option>Bangalore</option>
            <option>Hyderabad</option>
            <option>Mumbai</option>
            <option>Pune</option>
            <option>Chennai</option>
            <option>Noida</option>
            <option>Remote</option>
          </select>
          <select id="filter-mode" class="select filter-bar__select" aria-label="Filter by work mode">
            <option value="">All Modes</option>
            <option>Remote</option>
            <option>Hybrid</option>
            <option>Onsite</option>
          </select>
          <select id="filter-experience" class="select filter-bar__select" aria-label="Filter by experience">
            <option value="">All Experience</option>
            <option>Fresher</option>
            <option>0-1</option>
            <option>1-3</option>
            <option>3-5</option>
          </select>
          <select id="filter-source" class="select filter-bar__select" aria-label="Filter by source">
            <option value="">All Sources</option>
            <option>LinkedIn</option>
            <option>Naukri</option>
            <option>Indeed</option>
          </select>
          <select id="filter-sort" class="select filter-bar__select" aria-label="Sort jobs">
            <option value="latest">Latest First</option>
            <option value="oldest">Oldest First</option>
            <option value="az">A &rarr; Z (Company)</option>
            <option value="score">Match Score &darr;</option>
            <option value="salary">Salary &darr;</option>
          </select>
          <span class="filter-bar__count" id="filter-count" aria-live="polite"></span>
        </div>
        <!-- Match threshold toggle -->
        <div class="filter-bar__row2">
          <label class="match-toggle-label">
            <input type="checkbox" id="match-toggle" class="match-toggle__input" aria-label="Show only jobs above my threshold" />
            <span class="match-toggle__text">Show only jobs above my threshold</span>
          </label>
        </div>
      </div>

      <!-- Job grid -->
      <div class="job-grid-shell route-placeholder">
        <div id="job-grid" class="job-grid" role="list" aria-label="Job listings"></div>
        <div id="dashboard-empty" class="empty-state" style="display:none;">
          <div class="empty-state__icon" aria-hidden="true">&#9744;</div>
          <p class="empty-state__title">No roles match your criteria.</p>
          <p class="empty-state__body">Adjust your filters, lower your threshold, or <a href="#/settings" style="color:var(--color-accent);">update preferences</a>.</p>
        </div>
      </div>

    </div>

    <!-- ── Route: /saved ──────────────────────── -->
    <div class="route-view" data-view="/saved" id="view-saved" role="main" aria-label="Saved jobs">
      <div class="route-placeholder">
        <span class="route-placeholder__eyebrow label text-muted">Bookmarks</span>
        <h1 class="route-placeholder__heading">Saved Jobs</h1>
        <p class="route-placeholder__subtext">Positions you've bookmarked for review and future application.</p>
        <div class="route-placeholder__divider" aria-hidden="true"></div>
        <div id="saved-grid" class="job-grid" role="list" aria-label="Saved job listings"></div>
        <div id="saved-empty" class="empty-state">
          <div class="empty-state__icon" aria-hidden="true">&#9825;</div>
          <p class="empty-state__title">Nothing saved yet.</p>
          <p class="empty-state__body">Click “Save” on any job from the Dashboard to bookmark it here.</p>
        </div>
      </div>
    </div>

    <!-- ── Route: /digest ────────────────────── -->
    <div class="route-view" data-view="/digest" id="view-digest" role="main" aria-label="Digest">
      <div class="route-placeholder">
        <span class="route-placeholder__eyebrow label text-muted">Daily Summary</span>
        <h1 class="route-placeholder__heading">Digest</h1>
        <p class="route-placeholder__subtext">Your curated daily briefing — top matched roles delivered at 9AM.</p>
        <div class="route-placeholder__divider" aria-hidden="true"></div>
        <div class="empty-state">
          <div class="empty-state__icon" aria-hidden="true">&#9728;</div>
          <p class="empty-state__title">No digest yet.</p>
          <p class="empty-state__body">Your first digest will be generated once your preferences are saved and jobs are tracked.</p>
        </div>
      </div>
    </div>

    <!-- ── Route: /settings ──────────────────── -->
    <div class="route-view" data-view="/settings" id="view-settings" role="main" aria-label="Settings">
      <div class="route-placeholder">
        <span class="route-placeholder__eyebrow label text-muted">Configuration</span>
        <h1 class="route-placeholder__heading">Settings</h1>
        <p class="route-placeholder__subtext">Set your job preferences so we can match and deliver only the roles that matter to you.</p>
        <div class="route-placeholder__divider" aria-hidden="true"></div>

        <form class="settings-form" id="prefs-form" aria-label="Job preferences form">

          <!-- Role Keywords -->
          <div class="settings-form__group">
            <label class="settings-form__label label" for="field-keywords">Role Keywords</label>
            <input
              id="field-keywords"
              type="text"
              class="input settings-form__input"
              placeholder="e.g. React Developer, Frontend, Node.js"
              aria-describedby="hint-keywords"
            />
            <span id="hint-keywords" class="settings-form__hint">Separate with commas. Matched against job title (+25) and description (+15).</span>
          </div>

          <!-- Preferred Locations -->
          <div class="settings-form__group">
            <label class="settings-form__label label" for="field-locations">Preferred Locations</label>
            <select id="field-locations" class="select settings-form__input" multiple size="4" aria-describedby="hint-locations">
              <option value="Bangalore">Bangalore</option>
              <option value="Hyderabad">Hyderabad</option>
              <option value="Mumbai">Mumbai</option>
              <option value="Pune">Pune</option>
              <option value="Chennai">Chennai</option>
              <option value="Noida">Noida</option>
              <option value="Remote">Remote</option>
            </select>
            <span id="hint-locations" class="settings-form__hint">Hold Ctrl / Cmd to select multiple cities. Matched against job location (+15).</span>
          </div>

          <!-- Work Mode -->
          <div class="settings-form__group">
            <span class="settings-form__label label" id="mode-group-label">Work Mode</span>
            <div class="settings-form__checkboxes" role="group" aria-labelledby="mode-group-label">
              <label class="settings-form__checkbox-label"><input type="checkbox" class="settings-form__checkbox" name="pref-mode" value="Remote" /> Remote</label>
              <label class="settings-form__checkbox-label"><input type="checkbox" class="settings-form__checkbox" name="pref-mode" value="Hybrid" /> Hybrid</label>
              <label class="settings-form__checkbox-label"><input type="checkbox" class="settings-form__checkbox" name="pref-mode" value="Onsite" /> Onsite</label>
            </div>
            <span class="settings-form__hint">Any checked mode earns +10 when matched.</span>
          </div>

          <!-- Experience Level -->
          <div class="settings-form__group">
            <label class="settings-form__label label" for="field-experience-pref">Experience Level</label>
            <select id="field-experience-pref" class="select settings-form__input" aria-describedby="hint-experience">
              <option value="">Any experience level</option>
              <option value="Fresher">Fresher (0 years)</option>
              <option value="0-1">0&ndash;1 Years</option>
              <option value="1-3">1&ndash;3 Years</option>
              <option value="3-5">3&ndash;5 Years</option>
            </select>
            <span id="hint-experience" class="settings-form__hint">Earns +10 when it matches the job's requirement exactly.</span>
          </div>

          <!-- Skills -->
          <div class="settings-form__group">
            <label class="settings-form__label label" for="field-skills">Your Skills</label>
            <input
              id="field-skills"
              type="text"
              class="input settings-form__input"
              placeholder="e.g. React, Python, SQL, AWS"
              aria-describedby="hint-skills"
            />
            <span id="hint-skills" class="settings-form__hint">Separate with commas. Any overlap with job skills earns +15.</span>
          </div>

          <!-- Minimum Match Score -->
          <div class="settings-form__group">
            <label class="settings-form__label label" for="field-minscore">
              Minimum Match Score &mdash; <strong id="minscore-display">40</strong>
            </label>
            <input
              id="field-minscore"
              type="range"
              class="settings-form__slider"
              min="0" max="100" step="5" value="40"
              aria-describedby="hint-minscore"
            />
            <span id="hint-minscore" class="settings-form__hint">Jobs below this score are hidden when the threshold toggle is enabled on Dashboard.</span>
          </div>

          <div class="settings-form__footer">
            <button type="submit" class="btn btn--primary" id="save-prefs-btn">Save Preferences</button>
            <button type="button" class="btn" id="clear-prefs-btn">Clear</button>
          </div>

          <div id="prefs-saved-msg" class="settings-form__saved-msg" style="display:none;" aria-live="polite">
            &#10003; Preferences saved. Head to <a href="#/dashboard">Dashboard</a> to see your matches.
          </div>

        </form>
      </div>
    </div>

    <!-- ── Route: /proof ─────────────────────── -->
    <div class="route-view" data-view="/proof" id="view-proof" role="main" aria-label="Proof">
      <div class="route-placeholder">
        <span class="route-placeholder__eyebrow label text-muted">Verification</span>
        <h1 class="route-placeholder__heading">Proof</h1>
        <p class="route-placeholder__subtext">Artifact collection — evidence that every notification was delivered, seen, and acted upon.</p>
        <div class="route-placeholder__divider" aria-hidden="true"></div>
        <div class="empty-state">
          <div class="empty-state__icon" aria-hidden="true">&#10003;</div>
          <p class="empty-state__title">No artifacts yet.</p>
          <p class="empty-state__body">Proof logs, delivery receipts, and action confirmations will be collected here once the system is live.</p>
        </div>
      </div>
    </div>

    <!-- ── Route: /404 (Page Not Found) ────────── -->
    <div class="route-view" data-view="/404" id="view-404" role="main" aria-label="Page not found">
      <div class="route-placeholder">
        <span class="route-placeholder__eyebrow label text-muted">404</span>
        <h1 class="route-placeholder__heading">Page Not Found</h1>
        <p class="route-placeholder__subtext">
          The page you're looking for doesn't exist. Check the URL or use the navigation above.
        </p>
        <div class="route-placeholder__divider" aria-hidden="true"></div>
        <div class="route-placeholder__region">
          <span class="route-placeholder__region-label">Nothing here</span>
          <p class="route-placeholder__region-note">
            Try navigating to Dashboard, Saved, Digest, Settings, or Proof.
          </p>
          <a href="#/" style="margin-top: var(--space-2); font-family: var(--font-sans); font-size: var(--text-sm); color: var(--color-accent); text-decoration: underline;">← Back to Home</a>
        </div>
      </div>
    </div>

  </div><!-- /.app-body -->


  <!-- ══════════════════════════════════════════════
       JOB DETAIL MODAL
  ══════════════════════════════════════════════ -->
  <div class="modal-overlay" id="job-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-hidden="true">
    <div class="modal">
      <div class="modal__header">
        <div class="modal__header-titles">
          <h2 class="modal__title" id="modal-title"></h2>
          <span class="modal__company" id="modal-company"></span>
        </div>
        <button class="modal__close" id="modal-close" aria-label="Close job detail">&times;</button>
      </div>
      <div class="modal__body">
        <div class="modal__meta-grid" id="modal-meta"></div>
        <div>
          <p class="modal__section-label">About this role</p>
          <p class="modal__description" id="modal-description"></p>
        </div>
        <div>
          <p class="modal__section-label">Skills required</p>
          <div class="modal__skills" id="modal-skills"></div>
        </div>
      </div>
      <div class="modal__footer">
        <button class="btn job-card__btn" id="modal-save-btn">Save</button>
        <a class="btn btn--primary" id="modal-apply-btn" target="_blank" rel="noopener noreferrer">Apply Now ↗</a>
      </div>
    </div>
  </div>


  <!-- ══════════════════════════════════════════════
       HASH ROUTER
       No libraries. No dependencies.
       Reads window.location.hash → shows matching
       route-view, marks matching nav links is-active.
  ══════════════════════════════════════════════ -->
  <script>
    (() => {
      'use strict';

      // ── Route registry ────────────────────────────────
      // key   : hash path   (what appears after "#")
      // title : <title> tag value
      const routes = {
        '/':          { title: 'Home — Job Notification Tracker' },
        '/dashboard': { title: 'Dashboard — Job Notification Tracker' },
        '/saved':     { title: 'Saved Jobs — Job Notification Tracker' },
        '/digest':    { title: 'Digest — Job Notification Tracker' },
        '/settings':  { title: 'Settings — Job Notification Tracker' },
        '/proof':     { title: 'Proof — Job Notification Tracker' },
        '/404':       { title: 'Page Not Found — Job Notification Tracker' },
      };

      const defaultRoute = '/';

      // ── DOM refs ──────────────────────────────────────
      const allViews        = document.querySelectorAll('.route-view');
      const desktopLinks    = document.querySelectorAll('#desktop-nav .app-nav__link');
      const mobileLinks     = document.querySelectorAll('.app-nav__mobile-link');
      const hamburgerBtn    = document.getElementById('hamburger-btn');
      const mobileMenu      = document.getElementById('mobile-menu');

      // ── Parse current hash → route path ──────────────
      function getPath() {
        const hash = window.location.hash; // e.g. "#/dashboard"
        if (!hash || hash === '#') return defaultRoute;
        const path = hash.startsWith('#') ? hash.slice(1) : hash;
        // Unknown path → show 404, never a blank screen
        return routes[path] ? path : '/404';
      }

      // ── Activate a route ──────────────────────────────
      function navigate(path) {
        const route = routes[path];
        if (!route) return;

        // 1. Update page title
        document.title = route.title;

        // 2. Show matching view, hide all others
        allViews.forEach(view => {
          const isActive = view.dataset.view === path;
          view.classList.toggle('is-active', isActive);
        });

        // 3. Mark active desktop nav link
        desktopLinks.forEach(li => {
          const isActive = li.dataset.route === path;
          li.classList.toggle('is-active', isActive);
          const anchor = li.querySelector('a');
          if (anchor) anchor.setAttribute('aria-current', isActive ? 'page' : 'false');
        });

        // 4. Mark active mobile nav link
        mobileLinks.forEach(li => {
          const isActive = li.dataset.route === path;
          li.classList.toggle('is-active', isActive);
          const anchor = li.querySelector('a');
          if (anchor) anchor.setAttribute('aria-current', isActive ? 'page' : 'false');
        });

        // 5. Close mobile menu on navigate
        closeMobileMenu();
      }

      // ── Mobile menu toggle ────────────────────────────
      function closeMobileMenu() {
        mobileMenu.classList.remove('is-open');
        hamburgerBtn.setAttribute('aria-expanded', 'false');
        mobileMenu.setAttribute('aria-hidden', 'true');
      }

      function toggleMobileMenu() {
        const isOpen = mobileMenu.classList.contains('is-open');
        if (isOpen) {
          closeMobileMenu();
        } else {
          mobileMenu.classList.add('is-open');
          hamburgerBtn.setAttribute('aria-expanded', 'true');
          mobileMenu.setAttribute('aria-hidden', 'false');
        }
      }

      hamburgerBtn.addEventListener('click', toggleMobileMenu);

      // Close mobile menu on Escape key
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') closeMobileMenu();
      });

      // Close mobile menu when clicking outside the nav
      document.addEventListener('click', e => {
        const nav = document.querySelector('.app-nav');
        if (
          mobileMenu.classList.contains('is-open') &&
          !nav.contains(e.target) &&
          !mobileMenu.contains(e.target)
        ) {
          closeMobileMenu();
        }
      });

      // ── Hash change listener ──────────────────────────
      window.addEventListener('hashchange', () => navigate(getPath()));

      // ── Initial load ──────────────────────────────────
      // If arriving with no hash, default to home without
      // replacing browser history.
      if (!window.location.hash || window.location.hash === '#') {
        window.location.replace('#/');
      }
      navigate(getPath());

    })();
  </script>


  <!-- ══════════════════════════════════════════════
       PHASE 4 — JOB RENDERING ENGINE
       Reads window.JOBS, handles filter, save, modal.
       No framework. No dependencies.
  ══════════════════════════════════════════════ -->
  <script>
    (() => {
      'use strict';

      const STORAGE_KEY = 'jnt_saved_jobs';

      // ── Saved jobs (Set of ids, persisted to localStorage) ────
      function getSaved() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return new Set(raw ? JSON.parse(raw) : []);
        } catch { return new Set(); }
      }

      function setSaved(set) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify([...set]));
      }

      let saved = getSaved();

      // ── Helpers ────────────────────────────────────────────────
      function postedLabel(days) {
        if (days === 0) return 'Posted today';
        if (days === 1) return '1 day ago';
        return `${days} days ago`;
      }

      function modeClass(mode) {
        return 'job-card__mode--' + mode.toLowerCase();
      }

      function esc(str) {
        const d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
      }

      // ── Defensive field fallbacks ───────────────────────────────
      function safe(val, fallback) {
        return (val !== undefined && val !== null && String(val).trim() !== '') ? val : fallback;
      }

      // ── Build a single job card HTML string ────────────────────
      // score: number (0-100) | null (no prefs set)
      function buildCard(job, score) {
        const isSaved = saved.has(job.id);
        const title      = safe(job.title,      'Untitled Role');
        const company    = safe(job.company,    'Unknown Company');
        const location   = safe(job.location,   'Location not listed');
        const experience = safe(job.experience, 'Experience not listed');
        const mode       = safe(job.mode,       'Onsite');
        const salary     = safe(job.salaryRange,'Salary not disclosed');
        const source     = safe(job.source,     'Source unknown');
        const applyUrl   = safe(job.applyUrl,   '#');
        const posted     = (typeof job.postedDaysAgo === 'number') ? job.postedDaysAgo : null;

        // Match score badge
        let badgeHTML = '';
        if (score !== null && score !== undefined) {
          const badgeClass = score >= 80 ? 'match-badge--green'
                           : score >= 60 ? 'match-badge--amber'
                           : score >= 40 ? 'match-badge--neutral'
                           :               'match-badge--grey';
          badgeHTML = `<span class="match-badge ${badgeClass}" title="Match score: ${score}">${score}</span>`;
        }

        return `
          <article class="job-card" role="listitem" data-id="${job.id}">
            <div class="job-card__header">
              <div class="job-card__titles">
                <div style="display:flex;align-items:center;gap:var(--space-1);flex-wrap:wrap;">
                  <span class="job-card__title">${esc(title)}</span>
                  ${badgeHTML}
                </div>
                <span class="job-card__company">${esc(company)}</span>
              </div>
              <span class="job-card__source">${esc(source)}</span>
            </div>
            <div class="job-card__meta">
              <span class="job-card__meta-item">${esc(location)}</span>
              <span class="job-card__meta-item">${esc(experience)}</span>
              <span class="job-card__mode ${modeClass(mode)}">${esc(mode)}</span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span class="job-card__salary">${esc(salary)}</span>
              <span class="job-card__posted">${posted !== null ? postedLabel(posted) : 'Recently posted'}</span>
            </div>
            <div class="job-card__footer">
              <button class="job-card__btn job-card__btn--view" data-id="${job.id}" aria-label="View details for ${esc(title)}">View</button>
              <button class="job-card__btn job-card__btn--save ${isSaved ? 'is-saved' : ''}" data-id="${job.id}" aria-label="${isSaved ? 'Unsave' : 'Save'} ${esc(title)}" aria-pressed="${isSaved}">
                ${isSaved ? '&#9829; Saved' : '&#9825; Save'}
              </button>
              <a class="job-card__btn job-card__btn--apply" href="${esc(applyUrl)}" target="_blank" rel="noopener noreferrer" aria-label="Apply for ${esc(title)}">Apply &#8599;</a>
            </div>
          </article>
        `;
      }

      // ── Render dashboard grid ──────────────────────────────────
      // scoredJobs: [{job, score}]  score = number | null
      function renderDashboard(scoredJobs) {
        const grid  = document.getElementById('job-grid');
        const empty = document.getElementById('dashboard-empty');
        const count = document.getElementById('filter-count');
        if (!grid) return;
        if (scoredJobs.length === 0) {
          grid.innerHTML = '';
          grid.style.display = 'none';
          empty.style.display = '';
          count.textContent = '0 jobs';
        } else {
          grid.innerHTML = scoredJobs.map(s => buildCard(s.job, s.score)).join('');
          grid.style.display = '';
          empty.style.display = 'none';
          count.textContent = `${scoredJobs.length} job${scoredJobs.length !== 1 ? 's' : ''}`;
        }
      }

      // ── Render saved page ──────────────────────────────────────
      function renderSaved() {
        const grid  = document.getElementById('saved-grid');
        const empty = document.getElementById('saved-empty');
        if (!grid) return;
        saved = getSaved();
        const savedJobs = (window.JOBS || []).filter(j => saved.has(j.id));
        if (savedJobs.length === 0) {
          grid.innerHTML = '';
          grid.style.display = 'none';
          empty.style.display = '';
        } else {
          grid.innerHTML = savedJobs.map(j => buildCard(j, null)).join('');
          grid.style.display = '';
          empty.style.display = 'none';
        }
      }

      // ── Filter logic ───────────────────────────────────────────
      function getFiltered() {
        const kw  = (document.getElementById('filter-keyword')?.value  || '').toLowerCase().trim();
        const loc = (document.getElementById('filter-location')?.value || '').toLowerCase();
        const mod = (document.getElementById('filter-mode')?.value     || '').toLowerCase();
        const exp = (document.getElementById('filter-experience')?.value|| '').toLowerCase();
        const src = (document.getElementById('filter-source')?.value   || '').toLowerCase();
        const srt = (document.getElementById('filter-sort')?.value     || 'latest');

        let jobs = (window.JOBS || []).filter(j => {
          if (kw  && !j.title.toLowerCase().includes(kw)  && !j.company.toLowerCase().includes(kw))  return false;
          if (loc && j.location.toLowerCase()  !== loc)   return false;
          if (mod && j.mode.toLowerCase()       !== mod)   return false;
          if (exp && j.experience.toLowerCase() !== exp)   return false;
          if (src && j.source.toLowerCase()     !== src)   return false;
          return true;
        });

        if (srt === 'latest')  jobs = jobs.sort((a, b) => a.postedDaysAgo - b.postedDaysAgo);
        if (srt === 'oldest')  jobs = jobs.sort((a, b) => b.postedDaysAgo - a.postedDaysAgo);
        if (srt === 'az')      jobs = jobs.sort((a, b) => a.company.localeCompare(b.company));

        return jobs;
      }

      function applyFilters() {
        const { scored, hasP } = getScoredFiltered();
        const banner = document.getElementById('pref-banner');
        if (banner) banner.style.display = hasP ? 'none' : '';
        renderDashboard(scored);
        updateAllSaveButtons();
      }

      // ── Update all save button states (after toggle) ───────────
      function updateAllSaveButtons() {
        document.querySelectorAll('.job-card__btn--save').forEach(btn => {
          const id = parseInt(btn.dataset.id, 10);
          const is = saved.has(id);
          btn.classList.toggle('is-saved', is);
          btn.setAttribute('aria-pressed', is);
          btn.innerHTML = is ? '&#9829; Saved' : '&#9825; Save';
        });
      }

      // ── Toggle save ────────────────────────────────────────────
      function toggleSave(id) {
        saved = getSaved();
        if (saved.has(id)) {
          saved.delete(id);
        } else {
          saved.add(id);
        }
        setSaved(saved);
        updateAllSaveButtons();
        // If on saved page, re-render it
        const savedView = document.getElementById('view-saved');
        if (savedView && savedView.classList.contains('is-active')) {
          renderSaved();
        }
        // Update modal save button if open for same job
        const modal = document.getElementById('job-modal');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        if (modal && modal.classList.contains('is-open') && modalSaveBtn) {
          const modalId = parseInt(modal.dataset.jobId, 10);
          if (modalId === id) {
            const isSaved = saved.has(id);
            modalSaveBtn.textContent = isSaved ? '♥ Saved' : '♡ Save';
            modalSaveBtn.classList.toggle('is-saved', isSaved);
          }
        }
      }

      // ── Modal ──────────────────────────────────────────────────
      function openModal(id) {
        const job = (window.JOBS || []).find(j => j.id === id);
        if (!job) return;

        const modal = document.getElementById('job-modal');
        document.getElementById('modal-title').textContent   = safe(job.title,      'Untitled Role');
        document.getElementById('modal-company').textContent = safe(job.company,    'Unknown Company');
        document.getElementById('modal-description').textContent = safe(job.description, 'No description available.');

        // Meta grid
        const posted = (typeof job.postedDaysAgo === 'number') ? postedLabel(job.postedDaysAgo) : 'Recently';
        document.getElementById('modal-meta').innerHTML = `
          <div class="modal__meta-item"><span class="modal__meta-label">Location</span><span class="modal__meta-value">${esc(safe(job.location,'Not listed'))}</span></div>
          <div class="modal__meta-item"><span class="modal__meta-label">Mode</span><span class="modal__meta-value">${esc(safe(job.mode,'Not listed'))}</span></div>
          <div class="modal__meta-item"><span class="modal__meta-label">Experience</span><span class="modal__meta-value">${esc(safe(job.experience,'Not listed'))}</span></div>
          <div class="modal__meta-item"><span class="modal__meta-label">Salary</span><span class="modal__meta-value">${esc(safe(job.salaryRange,'Salary not disclosed'))}</span></div>
          <div class="modal__meta-item"><span class="modal__meta-label">Source</span><span class="modal__meta-value">${esc(safe(job.source,'Unknown'))}</span></div>
          <div class="modal__meta-item"><span class="modal__meta-label">Posted</span><span class="modal__meta-value">${posted}</span></div>
        `;

        // Skills
        const skills = Array.isArray(job.skills) && job.skills.length ? job.skills : ['No skills listed'];
        document.getElementById('modal-skills').innerHTML =
          skills.map(s => `<span class="modal__skill-tag">${esc(s)}</span>`).join('');

        // Footer buttons
        const isSaved = saved.has(id);
        const saveBtn  = document.getElementById('modal-save-btn');
        const applyBtn = document.getElementById('modal-apply-btn');
        saveBtn.textContent = isSaved ? '♥ Saved' : '♡ Save';
        saveBtn.classList.toggle('is-saved', isSaved);
        saveBtn.dataset.id = id;
        applyBtn.href = job.applyUrl;

        modal.dataset.jobId = id;
        modal.classList.add('is-open');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
        document.getElementById('modal-close').focus();
      }

      function closeModal() {
        const modal = document.getElementById('job-modal');
        modal.classList.remove('is-open');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }

      // ══════════════════════════════════════════════════════════
      // PHASE 5 — PREFERENCES + MATCH SCORE ENGINE
      // ══════════════════════════════════════════════════════════

      const PREFS_KEY = 'jobTrackerPreferences';

      function getPrefs() {
        try { return JSON.parse(localStorage.getItem(PREFS_KEY) || 'null'); }
        catch { return null; }
      }

      function hasPrefs(prefs) {
        if (!prefs) return false;
        return (prefs.roleKeywords    && prefs.roleKeywords.length    > 0) ||
               (prefs.preferredLocations && prefs.preferredLocations.length > 0) ||
               (prefs.preferredMode  && prefs.preferredMode.length   > 0) ||
               !!prefs.experienceLevel ||
               (prefs.skills         && prefs.skills.length          > 0);
      }

      // Scoring rules (spec-exact):
      // +25 keyword in title, +15 keyword in description
      // +15 location match, +10 mode match, +10 experience match
      // +15 any skill overlap, +5 posted<=2, +5 LinkedIn. Cap 100.
      function computeMatchScore(job, prefs) {
        let score = 0;
        const kws = (prefs.roleKeywords || []).filter(Boolean);

        if (kws.some(kw => job.title.toLowerCase().includes(kw.toLowerCase())))
          score += 25;
        if (kws.some(kw => (job.description || '').toLowerCase().includes(kw.toLowerCase())))
          score += 15;

        const locs = (prefs.preferredLocations || []).map(l => l.toLowerCase());
        if (locs.length && locs.includes((job.location || '').toLowerCase()))
          score += 15;

        const modes = (prefs.preferredMode || []).map(m => m.toLowerCase());
        if (modes.length && modes.includes((job.mode || '').toLowerCase()))
          score += 10;

        if (prefs.experienceLevel &&
            (job.experience || '').toLowerCase() === prefs.experienceLevel.toLowerCase())
          score += 10;

        const uSkills = (prefs.skills || []).filter(Boolean).map(s => s.toLowerCase());
        const jSkills = (job.skills  || []).map(s => s.toLowerCase());
        if (uSkills.length &&
            uSkills.some(us => jSkills.some(js => js.includes(us) || us.includes(js))))
          score += 15;

        if (typeof job.postedDaysAgo === 'number' && job.postedDaysAgo <= 2)
          score += 5;
        if (job.source === 'LinkedIn')
          score += 5;

        return Math.min(score, 100);
      }

      function extractSalaryNum(range) {
        const m = String(range || '').match(/\d+/);
        return m ? parseInt(m[0], 10) : 0;
      }

      // Returns {scored:[{job,score}], prefs, hasP}
      function getScoredFiltered() {
        const prefs = getPrefs();
        const hasP  = hasPrefs(prefs);

        const kw  = (document.getElementById('filter-keyword')?.value   || '').toLowerCase().trim();
        const loc = (document.getElementById('filter-location')?.value  || '').toLowerCase();
        const mod = (document.getElementById('filter-mode')?.value      || '').toLowerCase();
        const exp = (document.getElementById('filter-experience')?.value || '').toLowerCase();
        const src = (document.getElementById('filter-source')?.value    || '').toLowerCase();
        const srt = (document.getElementById('filter-sort')?.value      || 'latest');
        const matchOnly  = document.getElementById('match-toggle')?.checked || false;
        const threshold  = hasP ? (prefs.minMatchScore ?? 40) : 0;

        let jobs = (window.JOBS || []).filter(j => {
          if (kw  && !j.title.toLowerCase().includes(kw) &&
                     !j.company.toLowerCase().includes(kw))           return false;
          if (loc && (j.location   || '').toLowerCase() !== loc)      return false;
          if (mod && (j.mode       || '').toLowerCase() !== mod)      return false;
          if (exp && (j.experience || '').toLowerCase() !== exp)      return false;
          if (src && (j.source     || '').toLowerCase() !== src)      return false;
          return true;
        });

        const scored = jobs.map(j => ({
          job:   j,
          score: hasP ? computeMatchScore(j, prefs) : null
        }));

        const visible = (matchOnly && hasP)
          ? scored.filter(s => s.score >= threshold)
          : scored;

        if      (srt === 'latest')  visible.sort((a, b) => a.job.postedDaysAgo - b.job.postedDaysAgo);
        else if (srt === 'oldest')  visible.sort((a, b) => b.job.postedDaysAgo - a.job.postedDaysAgo);
        else if (srt === 'az')      visible.sort((a, b) => a.job.company.localeCompare(b.job.company));
        else if (srt === 'score')   visible.sort((a, b) => (b.score || 0) - (a.score || 0));
        else if (srt === 'salary')  visible.sort((a, b) =>
          extractSalaryNum(b.job.salaryRange) - extractSalaryNum(a.job.salaryRange));

        return { scored: visible, prefs, hasP };
      }

      // ── Settings: prefill from localStorage ───────────────────
      function prefillSettings() {
        const prefs = getPrefs();
        if (!prefs) return;

        const kwEl = document.getElementById('field-keywords');
        if (kwEl) kwEl.value = (prefs.roleKeywords || []).join(', ');

        const locEl = document.getElementById('field-locations');
        if (locEl) {
          Array.from(locEl.options).forEach(opt => {
            opt.selected = (prefs.preferredLocations || []).includes(opt.value);
          });
        }

        document.querySelectorAll('[name="pref-mode"]').forEach(cb => {
          cb.checked = (prefs.preferredMode || []).includes(cb.value);
        });

        const expEl = document.getElementById('field-experience-pref');
        if (expEl) expEl.value = prefs.experienceLevel || '';

        const skillEl = document.getElementById('field-skills');
        if (skillEl) skillEl.value = (prefs.skills || []).join(', ');

        const scoreEl      = document.getElementById('field-minscore');
        const scoreDisplay = document.getElementById('minscore-display');
        if (scoreEl) {
          scoreEl.value = prefs.minMatchScore ?? 40;
          if (scoreDisplay) scoreDisplay.textContent = scoreEl.value;
        }
      }

      // ── Settings: read form → build prefs object ──────────────
      function readPrefsFromForm() {
        const kwRaw    = document.getElementById('field-keywords')?.value    || '';
        const skillRaw = document.getElementById('field-skills')?.value      || '';
        const locEl    = document.getElementById('field-locations');
        const expEl    = document.getElementById('field-experience-pref');
        const scoreEl  = document.getElementById('field-minscore');

        return {
          roleKeywords:       kwRaw.split(',').map(s => s.trim()).filter(Boolean),
          preferredLocations: locEl
            ? Array.from(locEl.selectedOptions).map(o => o.value)
            : [],
          preferredMode: Array.from(
            document.querySelectorAll('[name="pref-mode"]:checked')
          ).map(cb => cb.value),
          experienceLevel: expEl?.value || '',
          skills:          skillRaw.split(',').map(s => s.trim()).filter(Boolean),
          minMatchScore:   scoreEl ? parseInt(scoreEl.value, 10) : 40,
        };
      }

      // ── Settings form: save ───────────────────────────────────
      const prefsForm = document.getElementById('prefs-form');
      if (prefsForm) {
        prefsForm.addEventListener('submit', e => {
          e.preventDefault();
          const prefs = readPrefsFromForm();
          localStorage.setItem(PREFS_KEY, JSON.stringify(prefs));
          const msg = document.getElementById('prefs-saved-msg');
          if (msg) { msg.style.display = ''; setTimeout(() => { msg.style.display = 'none'; }, 4000); }
        });
      }

      // ── Settings form: clear ──────────────────────────────────
      const clearPrefsBtn = document.getElementById('clear-prefs-btn');
      if (clearPrefsBtn) {
        clearPrefsBtn.addEventListener('click', () => {
          localStorage.removeItem(PREFS_KEY);
          if (prefsForm) prefsForm.reset();
          const sd = document.getElementById('minscore-display');
          if (sd) sd.textContent = '40';
          const msg = document.getElementById('prefs-saved-msg');
          if (msg) msg.style.display = 'none';
        });
      }

      // ── Slider live display ───────────────────────────────────
      const scoreSlider = document.getElementById('field-minscore');
      if (scoreSlider) {
        scoreSlider.addEventListener('input', () => {
          const d = document.getElementById('minscore-display');
          if (d) d.textContent = scoreSlider.value;
        });
      }

      // ── Match toggle ──────────────────────────────────────────
      const matchToggleEl = document.getElementById('match-toggle');
      if (matchToggleEl) matchToggleEl.addEventListener('change', applyFilters);

      // ── Event delegation — dashboard + saved grids ─────────────
      document.addEventListener('click', e => {
        // View button
        const viewBtn = e.target.closest('.job-card__btn--view');
        if (viewBtn) { openModal(parseInt(viewBtn.dataset.id, 10)); return; }

        // Save button (card)
        const saveBtn = e.target.closest('.job-card__btn--save');
        if (saveBtn) { toggleSave(parseInt(saveBtn.dataset.id, 10)); return; }

        // Save button (modal)
        if (e.target.id === 'modal-save-btn') {
          toggleSave(parseInt(e.target.dataset.id, 10)); return;
        }

        // Close modal
        if (e.target.id === 'modal-close' || e.target.id === 'job-modal') {
          closeModal(); return;
        }
      });

      // Close modal on Escape
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
          const modal = document.getElementById('job-modal');
          if (modal && modal.classList.contains('is-open')) closeModal();
        }
      });

      // Filter inputs — live filtering
      // keyword uses 'input' for instant search; selects use 'change'
      ['filter-keyword','filter-location','filter-mode','filter-experience','filter-source','filter-sort'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const evt = el.tagName === 'INPUT' ? 'input' : 'change';
        el.addEventListener(evt, applyFilters);
      });

      // ── Integrate with router ──────────────────────────────────
      // Hook into the navigate function the router defines by
      // listening to hashchange and also on initial render.
      function onRouteChange(path) {
        if (path === '/dashboard') {
          setTimeout(() => applyFilters(), 0);
        }
        if (path === '/saved') {
          setTimeout(() => renderSaved(), 0);
        }
        if (path === '/settings') {
          setTimeout(() => prefillSettings(), 0);
        }
      }

      window.addEventListener('hashchange', () => {
        const hash = window.location.hash || '#/';
        const path = hash.startsWith('#') ? hash.slice(1) : hash;
        onRouteChange(path);
      });

      // Initial route
      const initPath = (window.location.hash || '#/').slice(1) || '/';
      onRouteChange(initPath);

    })();
  </script>

</body>
</html>
